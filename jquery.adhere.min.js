(function(e){function t(t,i,s,o,u){if(fig_id=i.attr("id")){if(fig_id.match(/(ah-[0-9]+-[0-9]+)$/)){var a=fig_id.split(/-/);var f={w:a[a.length-2],h:a[a.length-1]}}}var l=e(o).width()||0;var c=e(o).height()||0;var h=e(s).children(":nth-child(2)").get(0);var p=e(s).children(":nth-child(1)").get(0);var d=h.nodeName!=p.nodeName?true:false;var v=1;var m=!d&&t.marker.html!="";i.css({position:"relative"});if("ontouchstart"in window){t.action.cEvent="click";alert("touch")}if(typeof f!="undefined"){if(l==0&&f.w!=null)l=f.w;if(c==0&&f.h!=null)c=f.h;if(f.w!=l){u=l/f.w}}if(t.collapseList){i.css({width:l+"px",height:c+"px"});e(s).css({position:"absolute",top:"0",left:"0"}).children().css(t.collapseList?{position:"absolute"}:"")}if(!t.collapseList||m){var g=e('<div id="adhere"></div>').css({width:l+"px",height:c+"px"});e(o).wrap(g)}e(s).children(d?":even":"").each(function(i,s){var o=s.getAttribute("data-coords")||s.getAttribute("id");var a=o!=null?o.split(/-/):[0,0];if(u!=null){a[1]=r(u,a[1]);a[2]=r(u,a[2])}if(a[1]>l)a[1]=l;else if(a[1]<0||a[1]==null)a[1]=0;if(a[2]>c)a[2]=c;else if(a[2]<0||a[2]==null)a[2]=0;if(!t.collapseList||m){var f=t.marker.html?t.marker.html:"<span>"+(t.captionContainer=="ol"?i+1:"&bull;")+"</span>";var h=s;s=e(f).css({position:"absolute"}).addClass(t.marker.className).appendTo(e("#adhere"))}var p=new n(s,t,v);p.alignMarker.addClass().x(a[1]).y(a[2]);p.bindEvent(d||m);if(d||m){if(t.smart){t.caption.xAlign=p.smartAlign(a[1],l)}if(m&&h!=null){p.alignCaption.pair=h}p.alignCaption.addClass().x().y();e(p.alignCaption.pair).hide()}v++})}function n(t,n,r){r=r||1;var i={xAligned:"",yAligned:"",alignMarker:{x:function(s){i.xAligned=this.al(n.marker.xAlign,s,e(t).outerWidth(true));e(t).css({left:i.xAligned+"px","z-index":r});return this},y:function(r){i.yAligned=this.al(n.marker.yAlign,r,e(t).outerHeight(true));e(t).css({top:i.yAligned+"px"});return this},al:function(e,t,n){switch(e){case"left":case"top":return t-n;case"right":case"bottom":return t+n;case"center":case"middle":return t-n/2;default:return 0}},addClass:function(){var r=n.marker.className||"";e(t).addClass(r);return this}},alignCaption:{pair:e(t).next()||"",x:function(r){capxAligned=this.al(n.caption.xAlign,i.xAligned,e(this.pair).outerWidth(true),e(t).outerWidth(true),n.caption.xDistance);e(this.pair).css({left:capxAligned+"px"});return this},y:function(r,s){capyAligned=this.al(n.caption.yAlign,i.yAligned,e(this.pair).outerHeight(true),e(t).outerHeight(true),n.caption.yDistance);e(this.pair).css({top:capyAligned+"px"});return this},al:function(e,t,n,r,i){var s=i||0;switch(e){case"left":case"top":return t-n-s;case"right":case"bottom":return t+r+s;case"center":case"middle":return t-n/2+r/2;default:return 0}},addClass:function(){var t=n.caption.className||"";e(this.pair).addClass(t);return this}},smartAlign:function(e,t){e=e||0;var r=t/2;if(n.smart=="smart-inner"){return e>r?"left":"right"}else if(n.smart=="smart-outer"){return e>r?"right":"left"}else return},bindEvent:function(r){var r=r||false;var i=n.action.cEvent||"";var s=n.action.cName||"";if(typeof s=="function")e(t).bind(i,function(){s.call(this,t)});else if(r)this.defaultCall()},defaultCall:function(){e(t).hover(function(){e(i.alignCaption.pair).fadeIn("fast")},function(){e(i.alignCaption.pair).fadeOut("fast")})}};return i}function r(e,t){return e*t}e.fn.adhere=function(n){n=e.extend(true,{captionContainer:"dl",collapseList:true,smart:false,marker:{className:"",xAlign:"center",yAlign:"center",html:""},caption:{className:"",xAlign:"center",yAlign:"center",xDistance:5,yDistance:5},action:{cEvent:"mouseover",cName:""}},n||{});return this.each(function(){var r=e(this);var i=e(this).find(n.captionContainer).get(0);var s=e(this).find("img").get(0);var u;if(s!=null){if(e.browser.webkit){e(s).load(function(){t(n,r,i,s,u)})}else t(n,r,i,s,u)}})}})(jQuery)